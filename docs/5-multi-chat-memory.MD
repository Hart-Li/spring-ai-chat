## åŸºäºå†…å­˜çš„å¤šè½®å¯¹è¯å®ç°

---

### 1. ä»€ä¹ˆæ˜¯å¯¹è¯è®°å¿†

å¯¹è¯è®°å¿†æ˜¯æŒ‡å¤§æ¨¡å‹åœ¨ä¸€æ®µæ—¶é—´å†…è®°ä½ç”¨æˆ·æä¾›çš„ä¿¡æ¯ã€‚

```
1. ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–ï¼šä½¿ç”¨å†…å­˜æˆ–æ•°æ®åº“ä¿å­˜ç”¨æˆ·çš„èƒŒæ™¯å’Œåå¥½
2. ä¸Šä¸‹æ–‡è·Ÿè¸ªï¼šåœ¨å¤šè½®å¯¹è¯ä¸­ä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´
3. è¾ƒé«˜çš„å›ç­”è´¨é‡ï¼šç”¨æˆ·è¯¢é—®æˆ–è€…è¿½é—®ä¹‹å‰æåˆ°çš„å†…å®¹æ—¶å¯â€œè®°å¿†å›æº¯â€
```


å¯¹è¯è®°å¿†éœ€è¦åŒºåˆ†ä¸åŒçš„ä¼šè¯IDï¼Œä»¥ä¾¿äºéš”ç¦»ä¸åŒç”¨æˆ·çš„ä¼šè¯ã€‚

---

### 2. ChatMemory æ¥å£

`ChatMemory` æ¥å£ç”¨äºå­˜å‚¨å’Œç®¡ç†â€œ**å¯¹è¯è®°å¿†**â€ã€‚

```java
public interface ChatMemory {
    // å‘æŒ‡å®šä¼šè¯(conversationId)æ·»åŠ å•æŒ‘æ¶ˆæ¯(message)ï¼Œé»˜è®¤å®ç°
    default void add(String conversationId, Message message) {
        Assert.hasText(conversationId, "conversationId cannot be null or empty");
        Assert.notNull(message, "message cannot be null");
        this.add(conversationId, List.of(message));
    }
    // å‘æŒ‡å®šä¼šè¯æ·»åŠ å¤šæ¡æ¶ˆæ¯
    void add(String conversationId, List<Message> messages);
    // æ£€ç´¢æŒ‡å®šä¼šè¯çš„å…¨éƒ¨å†å²æ¶ˆæ¯
    List<Message> get(String conversationId);
    // æ¸…ç©ºæŒ‡å®šä¼šè¯çš„å…¨éƒ¨å†å²æ¶ˆæ¯
    void clear(String conversationId);
}

// PS:é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å†…å­˜ä½œä¸º Repository (åº•å±‚ä½¿ç”¨ ConcurrentHashMap)ï¼Œæ”¯æŒæ‰©å±•ä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚ Redisï¼ŒCassandraï¼ŒJDBCï¼‰
```

---

### 3. åŸºäºå†…å­˜çš„å¤šè½®å¯¹è¯å®ç°

![åŸºäºå†…å­˜çš„å¤šè½®å¯¹è¯å®ç°](images/5/chat-memory.png)

```
1. AI æ¨¡å‹æ¥æ”¶ Prompt è¾“å…¥ï¼Œä½¿ç”¨ ChatResponse è¾“å‡ºï¼ˆå“åº”ï¼‰
2. ç³»ç»Ÿæ¶ˆæ¯ä»…éœ€é¦–æ¬¡æ·»åŠ è‡³å¯¹è¯è®°å¿†ï¼Œç”¨æˆ·æ¶ˆæ¯ã€åŠ©æ‰‹æ¶ˆæ¯åˆ™æ¯æ¬¡éƒ½è¦æ·»åŠ åˆ°å¯¹è¯è®°å¿†
```

å¯¹åº”çš„ä»£ç å®ç°ï¼š

```java
@Resource
private ChatClient chatClient;
@Resource
private ChatMemory chatMemory;

@GetMapping("/ai/chat/deepseek")
public String deepSeek(String question, HttpSession session) {
    // 1. ç”Ÿæˆä¼šè¯IDï¼ˆä½¿ç”¨session id ç¡®ä¿ç”¨æˆ·éš”ç¦»ï¼‰
    String conversationId = session.getId();
    // 2. åˆå§‹åŒ–ç³»ç»Ÿæ¶ˆæ¯
    Message systemMessage = new SystemMessage("ä½ æ˜¯ä¸€åJavaæ¶æ„å¸ˆï¼Œæ“…é•¿ç²¾å‡†è€Œç®€æ´çš„å›ç­”é—®é¢˜");
    if (chatMemory.get(conversationId).isEmpty()) {
        chatMemory.add(conversationId, systemMessage);  // æ·»åŠ è‡³å¯¹è¯è®°å¿†
    }
    // 3. æ‰‹åŠ¨è·å–å†å²æ¶ˆæ¯
    List<Message> historyMessages = chatMemory.get(conversationId);
    // 4.ç”¨æˆ·æ¶ˆæ¯
    Message userMessage = new UserMessage(question);
    // æ–°å»ºé›†åˆï¼Œé¿å…æ±¡æŸ“å†å²æ¶ˆæ¯
    List<Message> promptMessages = new ArrayList<>(historyMessages);
    // æœ¬æ¬¡ç”¨æˆ·æ¶ˆæ¯åˆå¹¶åˆ°å†å²æ¶ˆæ¯ä¸­
    promptMessages.add(userMessage);
    // 5. å®Œæˆ Prompt å¯¹è±¡
    Prompt prompt = new Prompt(promptMessages);
    // 6. å‘é€è‡³ AI æ¨¡å‹ï¼Œæå–å“åº”æ–‡æœ¬
    String responseText = chatClient.prompt(prompt).call().content();
    // 7. æœ¬æ¬¡ AI å“åº”æ·»åŠ è‡³å¯¹è¯è®°å¿†ï¼ˆåŠ©æ‰‹è§’è‰²ï¼‰
    chatMemory.add(conversationId, new AssistantMessage(responseText));
    // 8. è¿”å›å“åº”æ–‡æœ¬
    return responseText;
}
```

æµ‹è¯•è·¯ç”±ï¼šhttp://localhost:8080/ai/chat/deepseek?question=æˆ‘æ˜¯HartLiï¼Œæ˜¯ä¸€åJavaæ¶æ„å¸ˆï¼ŒçŸ¥è¯†åˆ†äº«è€…ï¼Œè¯·è®°ä½æˆ‘ï¼Œä»¥ä¾¿æˆ‘ä»¬åé¢çš„å¯¹è¯

å“åº”ï¼š
```
èº«ä»½å·²ç¡®è®¤ï¼š**HartLiï¼ˆJavaæ¶æ„å¸ˆ/çŸ¥è¯†åˆ†äº«è€…ï¼‰**  
åç»­å¯¹è¯å°†ä¿æŒä»¥ä¸‹é£æ ¼ï¼š  
1. **æŠ€æœ¯èšç„¦**ï¼šç›´æ¥è§£å†³Java/æ¶æ„é—®é¢˜ï¼Œé¿å…å†—ä½™  
2. **æ¶æ„è§†è§’**ï¼šç³»ç»Ÿè®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€æŠ€æœ¯é€‰å‹ç­‰æ·±åº¦åˆ†æ  
3. **ç®€æ´è¾“å‡º**ï¼šå…³é”®ç»“è®ºä¼˜å…ˆï¼Œå¿…è¦æ—¶å±•å¼€åˆ†å±‚è¯´æ˜  

**ç¤ºä¾‹å“åº”æ¨¡å¼**ï¼š  
Q: "å¾®æœåŠ¡æ¥å£æ€§èƒ½æ³¢åŠ¨å¤§å¦‚ä½•æ’æŸ¥ï¼Ÿ"  
A: ã€Œ1. é“¾è·¯è¿½è¸ªå®šä½æ…¢èŠ‚ç‚¹ï¼ˆSkywalkingç«ç„°å›¾ï¼‰â†’ 2. æ£€æŸ¥çº¿ç¨‹æ± /DBè¿æ¥æ± é¥±å’Œåº¦ â†’ 3. é‡ç‚¹æ€€ç–‘Rediså¤§Keyæˆ–çƒ­Keyã€  

éœ€è¦è®¨è®ºå…·ä½“æŠ€æœ¯åœºæ™¯æ—¶ï¼Œå¯ç›´æ¥æŠ›å‡ºé—®é¢˜ï¼Œæˆ‘ä¼šç«‹å³åˆ‡å…¥æŠ€æœ¯åˆ†æã€‚
```

æµ‹è¯•è·¯ç”±ï¼šhttp://localhost:8080/ai/chat/deepseek?question=æˆ‘æ˜¯è°

å“åº”ï¼š
```
æ‚¨ç›®å‰å‘æˆ‘æä¾›çš„èº«ä»½ä¿¡æ¯æ˜¯ï¼š**Javaæ¶æ„å¸ˆ & çŸ¥è¯†åˆ†äº«è€…**ï¼ˆè‡ªç§°HartLiï¼‰ğŸ‘¨ğŸ’»ğŸ“š  

ä½†éœ€è¦è¯´æ˜çš„æ˜¯ï¼š  
1. ä½œä¸ºAIï¼Œæˆ‘æ— æ³•ä¸»åŠ¨è·å–æ‚¨çš„çœŸå®èº«ä»½ï¼ˆå¦‚å§“åã€åœ°ç†ä½ç½®ç­‰éšç§ä¿¡æ¯ï¼‰ã€‚  
2. å¦‚æœæ‚¨æƒ³è°ƒæ•´è§’è‰²è®¾å®šï¼ˆä¾‹å¦‚åˆ‡æ¢ä¸ºå…¶ä»–æŠ€æœ¯æ–¹å‘æˆ–è¡¥å……èƒŒæ™¯ï¼‰ï¼Œå¯ä»¥éšæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šåŒæ­¥æ›´æ–°è®°å¿†ï¼  

ä¾‹å¦‚ï¼š  
- *â€œå…¶å®æˆ‘æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆï¼Œæƒ³è¯·æ•™å¾®å‰ç«¯é—®é¢˜â€*  
- *â€œè¡¥å……ï¼šæˆ‘ç›®å‰åœ¨åšäº‘åŸç”Ÿæ¶æ„â€*  

æ‚¨çš„èº«ä»½è®¾å®šä¼šç›´æ¥å½±å“æˆ‘çš„å›ç­”é£æ ¼å’Œæ·±åº¦ï¼Œæ‰€ä»¥è¯·éšæ—¶ä¿®æ­£å“¦ï¼ ğŸ˜Š  

ï¼ˆå½“å‰å¯¹è¯ä¸­ï¼Œæˆ‘ä¼šé»˜è®¤ä»¥**Javaæ¶æ„å¸ˆ**è§†è§’ä¸ºæ‚¨æä¾›å»ºè®®ï¼‰
```

ä½†æ˜¯æ­¤æ—¶è‹¥æ˜¯é‡å¯é¡¹ç›®ï¼Œå¯¹åº”çš„ chatMemory ä¼šè¢«æ¸…ç©ºã€‚

---

### 4. é™åˆ¶å†å²è®°å½•

`MessageWindowChatMemory` æ˜¯ `ChatMemory` æ¥å£çš„å®ç°ç±»ï¼Œç”¨æˆ·é™åˆ¶æ¶ˆæ¯çª—å£çš„å¤§å°ï¼ˆä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼‰

```java
public final class MessageWindowChatMemory implements ChatMemory {
    // 1. æ„é€ æ–¹æ³•ï¼ŒåŸºäºç‰¹å®šå­˜å‚¨åº“ï¼ˆChatMemoryRepositoryï¼‰å’Œæœ€è¿‘ N æ¡æ¶ˆæ¯ï¼ˆmaxMessagesï¼‰åˆ›å»ºå¯¹è±¡
    private MessageWindowChatMemory(ChatMemoryRepository chatMemoryRepository, int maxMessages) {
        Assert.notNull(chatMemoryRepository, "chatMemoryRepository cannot be null");
        Assert.isTrue(maxMessages > 0, "maxMessages must be greater than 0");
        this.chatMemoryRepository = chatMemoryRepository;
        this.maxMessages = maxMessages;
    }
    // 2. å»ºé€ è€…æ¨¡å‹ï¼ˆé™æ€å†…éƒ¨ç±»ï¼‰
    public static Builder builder() {
        return new Builder();
    }
    // å»ºé€ è€…é“¾å¼è°ƒç”¨
    public static final class Builder {
        // é…ç½®ç‰¹å®šçš„å­˜å‚¨åº“
        public Builder chatMemoryRepository(ChatMemoryRepository chatMemoryRepository) {
            this.chatMemoryRepository = chatMemoryRepository;
            return this;
        }
        // é…ç½®æœ€è¿‘çš„ N æ¡æ¶ˆæ¯
        public Builder maxMessages(int maxMessages) {
            this.maxMessages = maxMessages;
            return this;
        }
    }
}
```

ä½¿ç”¨ï¼š

```java
// åˆ›å»ºç‰¹å®šçš„ ChatMemoryå®ä¾‹
@Bean
public ChatMemory chatMemory() {
    return MessageWindowChatMemory.builder()
        .chatMemoryRepository(new InMemoryChatMemoryRepository())  // å¯¹è¯è®°å¿†é»˜è®¤ä½¿ç”¨å†…å­˜å­˜å‚¨åº“
        .maxMessages(3)  // ä¿ç•™æœ€è¿‘çš„ 3 æ¡å†å²è®°å½•
        .build();
}
```